<!Doctype html>
<html lang="en-us"><head>
    <meta charset="utf-8">
    <title>Multiple</title>

    <link rel="stylesheet" href="https://static.usurf.usu.edu/resources/wui-nextgen/wui-1-2/css/wui.css" type="text/css" media="all">
    <style type="text/css">
        .wui-multiple {
            display: flex;
            flex-wrap: wrap;

            /* From Wui.css line 138 .wui-fe input: */
            background-color: #ddd;
            border-style: solid;
            border-width: 1px;

            /* From wui.css line 137 : .wui-fe input, .wui-fe textarea, .wui-editor, .button li label, .wui-btn.field-btn */
            border-color: #bbb;

            /* From wui.css line 136: .wui-fe input, .wui-fe textarea, .wui-editor */
            border-radius: 4px;
            color: #444;
        }

        .wui-multiple input, .wui-multiple input:focus {
            outline: none;
            -webkit-appearance: none;
            background-color: transparent;
            border:none;
        }

        .wui-multiple select {display:none !important;}

        .wui-multiple > .wui-fe {
            flex: 1;
            min-width: 120px;
        }
        .wui-multiple span {
        padding: 0 0.33em;
        border-radius: 4px;
        line-height: 26px;
        }
        .wui-multiple span a {
            display:none;
            margin-left: 0.5em;
        }
        .wui-multiple span.wui-selected {margin:0 0.25em;}
        .wui-multiple span.wui-selected a {
            display: inline-block;
        }
        .wui-selected a {color:#fff;}
        .wui-selected a:hover {text-decoration: underline;}

        .wui-selected:focus{ outline: none; }
    </style>

    <script type="text/javascript" src="https://static.usurf.usu.edu/resources/wui-nextgen/wui-1-2/js/jquery-2-1-1-ui-1-10-4.js"></script>
    <script type="text/javascript" src="https://static.usurf.usu.edu/resources/wui-nextgen/wui-1-2/js/wui.js"></script>
    <script type="text/javascript" src="https://static.usurf.usu.edu/resources/wui-nextgen/wui-1-2/js/forms.js"></script>
    <script type="text/javascript" src="https://static.usurf.usu.edu/resources/wui-nextgen/wui-1-2/js/grid.js"></script>

    <script type="text/javascript">
        Wui.Multiple = function(args,combo){
            $.extend(this,{
                field:      $('<input>').attr('type','text'),
                data:       []
            },args);

            this.init(combo);
        }
        Wui.Multiple.prototype = $.extend(new Wui.DataList(), new Wui.FormField(), {
            init:           function(combo){
                                var me = this;

                                me.combo = $.extend(combo,{
                                    valChange:  function(obj){
                                                    if(obj.value !== null){
                                                        me.push(obj.value);
                                                        obj.val(null);
                                                        obj.field.val('');
                                                    }
                                                    
                                                }
                                });
                                me.combo.make();
                                me.defineTags();

                                // Get info from combo
                                $.extend(me,{
                                    valueItem:  me.combo.valueItem,
                                    url:        me.combo.url,
                                    params:     me.combo.params
                                });

                                me.selectTemplate = new Wui.Template({
                                    template:   '<option value={' +me.combo.valueItem+ '} selected="selected">{' +me.combo.titleItem+ '}</option>'
                                });

                                Wui.FormField.prototype.init.apply(me,arguments);
                                
                                (me.elAlias || me.el).addClass('wui-multiple').append(
                                    me.combo.el,
                                    me.selectEl = $('<select>',{
                                        multiple:   'multiple',
                                        name:       me.name || me.combo.name
                                    })
                                );
                            },
            defineTags:     function(){
                                this.template = 
                                    '<span>' +
                                        '{' +this.combo.titleItem+ '}' +
                                        '<a data-index="{wuiIndex}" href="javascript:void(0);">x</a>' +
                                    '</span>';
                            },
            onRender:       function(){
                                var me = this;
                                (me.elAlias || me.el).on('click','a',function(e){
                                    var wuiIndex = this.dataset.index;
                                    me.splice(wuiIndex,1);
                                });
                            },
            dataChanged:    function (){ 
                                this.make();

                                var me = this, 
                                    i = 0, 
                                    holder = $('<div>'),
                                    holdingData = $.extend(true,[],me.data) || [];

                                for(i = 0; i < holdingData.length; i++){
                                    me.selectTemplate.data = holdingData[i];
                                    holder.append(me.selectTemplate.make());
                                }

                                me.selectEl.empty().append(holder.children().unwrap());
                                me.value = me.data;

                            },
            push:           Wui.Data.prototype.push,
            splice:         Wui.Data.prototype.splice,
            /** Returns only the simple value of an item */
            getVal:         function(){
                                var retArray = [];
                                for(var i = 0; i < this.value.length; i++)
                                    retArray.push(this.value[i][this.valueItem]);
                                
                                return (retArray.length) ? retArray : null;
                            },
            setVal:         function(sv){
                                var me = this;

                                me.data = [];
                                me.make();
                                
                                // Space delimited strings of numbers are converterd to an array
                                if(typeof sv === 'string')
                                    sv = sv.split(' ');

                                console.log(sv);

                                // Single values are made an array of 1 element
                                if(!$.isArray(sv)){
                                    var tmp = sv;
                                    sv = []; sv[0] = tmp;
                                }

                                if(sv !== null && sv.length && sv.length > 0){
                                    if(typeof sv[0] !== 'object')    me.loadComboVals(sv);
                                    else                             me.setData(sv);
                                }
                            },
            loadComboVals:  function(sv){
                                var me = this;

                                if(me.url === null && me.combo.data.length){
                                    for(var i = 0; i < sv.length; i ++){
                                        if($.isNumeric(sv[i]) || (sv[i].length && sv[i].length > 0))
                                            me.push(me.combo.selectBy(me.combo.valueItem,sv[i]).rec);
                                    }
                                    me.combo.val(null);
                                }
                            },
            make:           function (){
                                var me = this,
                                    holdingData = me.data || [],
                                    holder = $('<div>'), 
                                    dn = (me.name) ? '.' + me.name : '';
                                
                                // Clear out items list
                                me.items = [];

                                // Add items to me.items
                                for(var i = 0; (me.displayMax < 0 && i < holdingData.length) || (me.displayMax > 0 && i < me.displayMax && i < holdingData.length); i++){
                                    var rec = me.data = holdingData[i],
                                        itm = {el:Wui.Template.prototype.make.call(me, i), rec:rec};
                                        
                                    Array.prototype.push.call(me.items,itm);
                                    holder.append(me.createItem(itm));
                                }
                                
                                // Clear out existing items and add new to the DOM
                                me.clear();
                                (me.elAlias || me.el).prepend(holder.children().unwrap());
                                me.data = holdingData;
                                
                                // Set autoLoad to true because it should only block on the first run, and if this functions is happened then the
                                // object has been manually run
                                me.autoLoad = true;
                                
                                // Event hook and event
                                me.afterMake();
                                me.el.trigger($.Event('refresh'+ dn),[me,me.data])
                                    .trigger($.Event('refresh'),[me,me.data]);
                                
                                // Reset selected items if any
                                me.resetSelect();
                            },
            clear:          function(){
                                this.combo.el.prevAll().remove();
                            }
        });

        var a = new Wui.Multiple(
            {
                label:          'Multi', 
                labelPosition:  'left',
                name:           'jeff'
            },
            new Wui.Combo({
                titleItem:      'name',
                valueItem:      'id',
                data:           [
                                    {id:'ste', name:'Stephen Nielsen'},
                                    {id:'kay', name:'Kayli Nielsen'},
                                    {id:'rac', name:'Rachel Nielsen'},
                                    {id:'ada', name:'Adam Nielsen'}
                                ]
            })
        );


        $(document).ready(function(){
            a.place();
        });
    </script>
</head>
<body>
</body></html>