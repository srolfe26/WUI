<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <title>WUI Test</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="css/wui.css" type="text/css" media="all">

    <style>
        .wui-pane {float:left; margin:1em;}
    </style>

    <script type="text/javascript" src="js/jquery-1-10-2-ui-1-10-3.js"></script>
    <script type="text/javascript" src="js/wui.js"></script>
    <script type="text/javascript" src="js/forms.js"></script>
    <script type="text/javascript" src="js/grid.js"></script>
    
    <style>
        /* combo */
        .wui-combo {position: relative;}
        .wui-fe .has-dd {padding-right:27px;}
        .wui-combo-dd {
            background:#fff; list-style:none; display:none; margin:0 !important; padding:0; position:absolute; 
            max-height:150px; overflow:auto; border:1px #ccc solid; border-top:none; border-radius: 0 0 4px 4px;
        }
        .wui-inline-dd {right:0; top:98%; width:100%;}
        .wui-combo-dd li { cursor:pointer; padding:2px 5px; margin:0 !important;  font-size:0.9em; }
            .wui-combo-dd li.wui-selected { background:#19f; color:#fff; }
            .wui-combo-dd li.wui-combo-hover { background:#aef; }
        .dd-wrapper, .wui-file {position:relative;}
        .wui-btn.field-btn.dd-switch { padding:0; width:26px; background-position: -12px -10px; margin: 0; }
    </style>

    <script type="text/javascript">
        $(document).ready(function(){
            
            Wui.Combo2 = function(args){ 
                $.extend(this, {
                    ddCls:      '',
                    field:      $('<input>').attr({type:'text'}),
                    titleItem:  null,
                    autoLoad:   true,
                    filterField:true,
                    minKeys:    2,
                    searchLocal:true
                },args); 

                // Create template when one hasn't been defined
                if(!this.hasOwnProperty('template') && this.hasOwnProperty('identity') && this.hasOwnProperty('titleItem') && this.identity.length && this.identity.length) 
                    this.template = '<li>{' +this.titleItem+ '}</li>';
                
                if(!this.template) throw new Error('Wui.js - Identity & titleItem, or template, are required configs for a Combo.');
                this.init(); 
            };
            Wui.Combo2.prototype = $.extend(new Wui.DataList(), new Wui.Text(), {
                /** Fires when the enter key is pressed */
                enterKey:   function(){
                                if(this.selectItm !== undefined)   this.selectItm.click();
                            },
                                
                /** Fires when the down arrow is pressed */
                keyDown:    function(){
                                if(!this.dd.is(':visible')){
                                    this.toggleDD('open');
                                }else{
                                    var si = (this.selectItm === undefined) ? 0 : this.dd.children('.wui-combo-hover ~ :visible:first').index(),
                                        idx = (si > 0) ? si : 0;
                                    this.resultHover(this.dd.children(':eq(' + idx + ')'));
                                }
                            },
                                
                /** Fires when the down up is pressed */
                keyUp:      function(){
                                if(this.selectItm !== undefined){
                                    var idx = this.selectItm.prevAll(':visible:first').index();
                                    
                                    if(idx < 0){
                                        this.field.focus().select();
                                        this.dd.children().removeClass('wui-combo-hover');
                                        this.selectItm = undefined;
                                    }else{
                                        this.resultHover(this.dd.children(':eq(' + idx + ')'));
                                    } 
                                }
                            },
                resultHover:function(itmTarget){
                                this.dd.children().removeClass('wui-combo-hover');
                                return this.selectItm = $(itmTarget).addClass('wui-combo-hover');
                            },
                getVal:     function(){ return this.value; },
                setVal:     function(sv){ 
                                var me = this;
                                
                                if(sv === null){
                                    me.clearSelect();
                                }else if(typeof sv == 'object'){
                                    // Select the item - if it doesn't exist then add it to the data set and select it
                                    if(!me.selectBy(me.identity,sv[me.identity])){
                                        me.data.push(sv);
                                        me.make();
                                        me.selectBy(me.identity,sv[me.identity]);
                                    }
                                }else{
                                    this.selectBy(this.identity,sv);
                                }
                            },
                clearSelect:function(){
                                var me = this;
                                me.dd.find('.wui-selected').removeClass('wui-selected');
                                Wui.DataList.prototype.clearSelect.apply(me,arguments);
                                me.value = null;
                                me.fieldText('');
                            },
                itemSelect: function(){
                                var me = this;
                                me.dd.find('.wui-selected').removeClass('wui-selected');
                                var retVal = me.value = Wui.DataList.prototype.itemSelect.apply(me,arguments).rec;
                                me.fieldText(me.value[me.titleItem]);
                                return retVal;
                            },
                init:       function(){
                                var me = this;
                                Wui.Text.prototype.init.call(me);

                                // Place field elements
                                me.append(
                                    me.wrapper = $('<div>').addClass('wui-combo').append(
                                        me.dd = $('<ul>').addClass('wui-combo-dd ' + me.ddCls),
                                        me.field
                                    )
                                );
                                // Create Dropdown Button
                                me.ddSwitch = new Wui.Button({
                                    click:      function(){ me.toggleDD(); },
                                    text:       '',
                                    tabIndex:   -1,
                                    appendTo:   me.wrapper,
                                    cls:        'field-btn dd-switch'
                                });
                                me.ddSwitch.place();
                            },
                make:       function(){
                                var me = this, tempAlias = me.elAlias;
                                me.elAlias = me.dd;
                                Wui.DataList.prototype.make.apply(me,arguments);
                                me.elAlias = tempAlias;
                            },
                onRender:   function(){
                                Wui.Text.prototype.onRender.apply(this,arguments);
                                Wui.DataList.prototype.onRender.apply(this,arguments);
                            },
                toggleDD:   function(force){
                                var me = this, isVis = me.dd.is(':visible');

                                if(force !== undefined){
                                    if(force == 'open') showDD();
                                    else                hideDD();
                                }else{
                                    if(isVis)           hideDD();
                                    else                showDD();
                                }

                                function hideDD(){ me.dd.hide(); }
                                function showDD(){
                                    if(!isVis){
                                        var ddWid   = parseInt(me.dd.css('width')),
                                            width   = (ddWid && ddWid > me.field.width()) ? ddWid : me.field.width(); 
                                        // Clear the drop down when it loses focus
                                        $(document).one('click',function(){ hideDD(); });
                                        $('body').append(me.dd.width(width).show());
                                        Wui.positionItem(me.field,me.dd);
                                        me.field.select();
                                    }   
                                }
                            },
                searchData: function(srchVal){
                                var me = this;
                                if(me.filterField){
                                    me.searchFilter = srchVal;
                                    
                                    if(me.searchLocal){
                                        me.toggleDD('open');
                                        me.dd.children()[(srchVal && srchVal.length > 0) ? 'hide' : 'show']();
                                        me.dd.children(':contains(' +srchVal+ ')').show();
                                        me.rsltHover(me.dd.children(':contains("' +srchVal+ '"):first'));
                                    }else{
                                        if(srchVal.length >= me.minKeys || srchVal.length === 0)
                                            me.loadData();
                                    }    
                                }
                            },
                setListeners:function(t){
                                return t.field
                                        .click(function(){ t.toggleDD('open'); return false; })
                                        .keyup(function(evnt){
                                            switch(evnt.keyCode){
                                                case 40:    /*Do Nothing*/  break;
                                                case 38:    /*Do Nothing*/  break;
                                                case 13:    /*Do Nothing*/  break;
                                                case 9:     /*Do Nothing*/  break;
                                                default:    t.searchData(t.field.val());
                                            }
                                        })
                                        .keydown(function(evnt){
                                            //clear the value if the user blanks out the field
                                            if(t.field.val().length === 0) t.value = null;
                                            
                                            if(t.data.length > 0){
                                                switch(evnt.keyCode){
                                                    case 40:    t.keyDown();   break;
                                                    case 38:    t.keyUp();     break;
                                                    case 13:
                                                    case 9:     t.enterKey();  break;
                                                }
                                                
                                                //scroll the list to the currently selected item
                                                t.scrollToCurrent();
                                            }
                                        });
                            }
            });

            a = new Wui.Combo2({label:'Foo', identity:'id', titleItem:'name', data:[
                {id:'1', name:'Tony'},
                {id:'2', name:'Dan'},
                {id:'3', name:'Keith'},
                {id:'4', name:'Julie'},
                {id:'5', name:'Josh'},
                {id:'6', name:'Catherine'}
            ]});
            a.place();

            /* Add a new grid on the body
            
            id = new Date();
            
            sub_a = new Wui.Grid({
                appendTo:       $('body'),
                data:           [
                                    {link:'docs/about.html', title:'-- About --'},
                                    {link:'docs/o.html', title:'WUI Object'},
                                    {link:'docs/text.html', title:'Text Box'},
                                    {link:'docs/textarea.html', title:'Text Area'},
                                    {link:'docs/template.html', title:'Template Engine'},
                                    {link:'docs/wysiwyg.html', title:'WYSIWYG'},
                                    {link:'docs/radio.html', title:'Radio'},
                                    {link:'docs/checkbox.html', title:'Checkbox'},
                                    {link:'docs/state.html', title:'State Machine', target:'_blank'},
                                    {link:'docs/data.html', title:'Data'},
                                    {link:'docs/data-list.html', title:'Data List'},
                                    {link:'docs/button.html', title:'Button'},
                                    {link:'docs/combo.html', title:'Combo'},
                                    {link:'docs/link.html', title:'Link Input'},
                                    {link:'docs/datetime.html', title:'Date/Time Input'},
                                    {link:'docs/file.html', title:'File'},
                                    {link:'docs/fit.html', title:'WUI Fit'},
                                    {link:'docs/pane.html', title:'Pane'},
                                    {link:'docs/window.html', title:'Window'},
                                    {link:'docs/forms.html', title:'Form'},
                                    {link:'docs/grid.html', title:'Grid'},
                                    {link:'docs/tabs.html', title:'Tabs'},
                                    {link:'docs/is-numeric.html', title:'isNumeric()'},
                                    {link:'docs/scrollbar-width.html', title:'scrollbarWidth()'},
                                    {link:'docs/input.html', title:'input()'}
                                ],
                processData:    function(d){
                                    console.log('asdf');
                                    return d.sort(function(a,b){
                                        return $.trim(a.title).toUpperCase().localeCompare($.trim(b.title).toUpperCase());
                                    });
                                },
                columns:        [{heading:'Feature', dataItem:'title'}],
                borderStyle:    {borderWidth: '0 6px 0 0', borderColor:'#888'},
                width:          300,
                height:         '90%'
            });
            sub_a.place();
            
            a = new Wui.Grid({
                height:    500,
                width:950,
                appendTo:$('body'),
                url:    'docs/data.txt',
                columns:[
                            {heading:'Date', dataItem:'date', dataType:'date', fit:0.75},
                            {heading:'Check Number', dataItem:'check_number', dataType:'numeric', vertical:true},
                            {heading:'Description', dataItem:'description', fit:5},
                            {heading:'Amount', dataItem:'amount', dataType:'numeric', fit:1},
                            //{heading:'', dataItem:'amount', dataType:'numeric', fit:1, renderer: function(cell,val,record,row){
                            //    var b = new Wui.Button({ text:'Reconcile', appendTo:cell, click:function(){ Wui.msg(val); }}); b.place(); return '';
                            //}},
                        ],
                multiSelect:true,
                afterMake: function(){ Wui.Grid.prototype.afterMake.call(this); var ed = new Date(); console.log((ed.getTime() - id.getTime()));}
            });
            a.place();*/
        }); // end document.ready
    </script>
</head>
<body></body>
</html>
