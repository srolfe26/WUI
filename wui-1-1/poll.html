<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <title>Poll</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="css/wui.css" type="text/css" media="all">

    <style>
        .wui-pane {float:left; margin:1em;}
    </style>

    <script type="text/javascript" src="js/jquery-1-10-2-ui-1-10-3.js"></script>
    <script type="text/javascript" src="js/wui.js"></script>
    <script type="text/javascript" src="js/forms.js"></script>
    <script type="text/javascript" src="js/grid.js"></script>

    <script type="text/javascript">
        Wui.longPoll = function(args){
            $.extend(this,{
                // The time in milliseconds between each polling. The ajax timeout parameter will also be set to this value so that the server will not be pestered faster than it can respond to a given request.
                pollTime:   1000,

                // A multiple of pollTime at which polling retries will cease.
                maxRetry:   120,

                // When a poll fails, retries will increase in length by this factor until 'maxRetry' has been reached.
                waitFactor: 2,

                // The URL of the resource to poll.
                url:        null,

                // Parameters to pass to the resource specified in URL.
                params:     null,

                // The name of the longPoll (useful to identifying its responses in the event that there are multiple polls on the same page), defaults to the result of Wui.id().
                name:       null,

                // Setting to pass to the jQuery AJAX function. Settings defined in the poll method already will be overridden.
                ajaxParams: {}
            },args);
            this.init();
        };
        Wui.longPoll.prototype = {
            init:       function(){
                            var me = this;
                            me.originalPollTime = me.pollTime;
                            me.pollTime = me.naturalPollTime = me.pollTime + 1;
                            me.name = (me.name) ? me.name : Wui.id();
                            me.poll();
                        },
            /** Polls a resource and sends events on success, failure, and if/when polling stops. */
            poll:       function(){
                            var me = this;
                            setTimeout(function() { 
                                $.ajax($.extend(me.ajaxParams, { 
                                    url:        me.url,
                                    data:       me.params,
                                    beforeSend: function(jqXHR){
                                                    if(me.pollTime > me.originalPollTime * me.maxRetry){
                                                        jqXHR.abort();
                                                        $(window).trigger($.Event('pollStopped'),[me]);
                                                        return false;
                                                    }
                                                },
                                    success:    function(data) { 
                                                    me.pollTime = me.naturalPollTime;
                                                    $(window).trigger($.Event('pollSuccess'),[me, data]);
                                                },
                                    dataType:   "text", 
                                    complete:   function(){ me.poll(); },
                                    timeout:    me.pollTime,
                                    error:      function(err){ 
                                                    // This allows the poll to retry once at the original poll time before increasing by a factor of waitFactor
                                                    me.pollTime = (me.pollTime == me.naturalPollTime) ? me.originalPollTime : me.pollTime * me.waitFactor;
                                                    $(window).trigger($.Event('pollError'),[me, err]);
                                                }
                                })); 
                            }, me.pollTime);
                        },

            /** Stops the poll engine */
            stopPoll:   function(){ me.pollTime = me.pollTime * me.maxRetry + 1; }

            /** Resumes the polling */
            startPoll:   function(){ me.pollTime = me.naturalPollTime; me.poll(); }
        };

       $(document).ready(function(){
            a = new Wui.longPoll({
                url:    'serv.html'
            });

            $(window).on('pollSuccess',function(){ console.log('success', arguments); });
            $(window).on('pollStopped',function(){ console.log('stopped', arguments); });
            $(window).on('pollError',function(){ console.log('error', arguments); });
        }); // end document.ready
    </script>
</head>
<body></body>
</html>
