/*! Wui 1.2.1
 * Copyright (c) 2014 Stephen Rolfe Nielsen - Utah State University Research Foundation 
 *
 * @license MIT
 * https://static.usurf.usu.edu/resources/wui-1.2.1/license.html
 */
!function(e,t){t.DateRange=function(n){var a=this,r=e.extend({value:{start_date:null,end_date:null},init:function(){function n(){a.field.val(a.startDate.toString()+" - "+a.endDate.toString()),a.setChanged()}var r=t.id("start-dt"),i=t.id("end-dt");t.FormField.prototype.init.call(this),a.append(a.startDate=new t.Datetime({blankText:"Start Date",dateOnly:!0,name:r,dispFormat:"START DATE: ddd MM-dd-yyyy"}),a.endDate=new t.Datetime({blankText:"End Date or # of Occurrences",dateOnly:!0,name:i,dispFormat:"END DATE: ddd MM-dd-yyyy"}),a.field=e("<input>",{type:"hidden"})),a.el.addClass("w121-date-fields"),a.el.on("valchange","[name="+i+"]",function(e,t,r,i){e.stopPropagation(),r!==i&&(a.value.end_date=r,n())}),a.el.on("valchange","."+r,function(e,t,r,i){e.stopPropagation(),r!==i&&(a.endDate.minDate=a.value.start_date=r,n())})},setVal:function(t){a.value=e.extend({},t),a.startDate.val(a.value.start_date),a.endDate.val(a.value.end_date)},getVal:function(){return a.value},validate:function(){var e=!0;return!a.required&&null===a.value.end_date||null!==a.value.start_date||(e=a.parent.throwError("The start date for '"+a.label+"' cannot be blank.")),null!==a.value.end_date&&a.value.start_date.valueOf()>=a.value.end_date.valueOf()&&(e=a.parent.throwError("The end date for '"+a.label+"' is before the start date.")),e}},n);e.extend(a,new t.FormField(r)),a.init()},t.DateRange.prototype=new t.FormField,t.Recurrence=function(t){e.extend(this,t,{field:e("<input>").attr({type:"text"}),maxPreviews:4,recurrenceFn:function(){},valIsOK:!1}),this.init()},t.Recurrence.prototype=e.extend(new t.Text,{blankText:"Recurrence Description",clearValue:function(){return this.value={startDate:null,endDate:null,unit:null,number:null,weekday:null,month:null,ordinal:null,monthDay:null,occurrences:null}},dispFormat:"ddd MM-dd-yyyy",dtFormat:"yyyy-MM-dd",feedback:function(){var n=this,a=n.value,r=t.Datetime.prototype;if(n.valIsOK=!1,n.dates.endDate.enable(),a){var i=r.validDate(a.startDate),l=a.unit?"add"+a.unit.charAt(0).toUpperCase()+a.unit.slice(1)+"s":"";1==a.occurrences&&i?(n.dates.endDate.disable(),n.setRecurrenceFn(n.recur(function(e){return e}))):"week"==a.unit&&e.isNumeric(a.weekday)?n.setRecurrenceFn(n.recur(function(e,t){var n=e[l](a.number*t),r=n.getMonth(),i=n.getFullYear(),u=n.getDate()+(a.weekday-n.getDay());return new Date(i,r,u)})):"month"==a.unit&&e.isNumeric(a.monthDay)?n.setRecurrenceFn(n.recur(function(e,t){var n=e[l](a.number*t);return new Date(n.getFullYear(),n.getMonth(),a.monthDay)})):("month"==a.unit||"year"==a.unit&&null!==a.month)&&e.isNumeric(a.ordinal)&&e.isNumeric(a.weekday)?n.setRecurrenceFn(n.recur(function(e,t){for(var n,r=e[l](a.number*t),i="year"==a.unit?a.month:r.getMonth(),u=r.getFullYear(),o=new Date(u,i,1),d=0;o.getMonth()==i&&d<a.ordinal;){if(o.getDay()==a.weekday&&(d+=1,n=new Date(o.getTime())),d==a.ordinal)return o;o.addDays(1)}return n})):"year"==a.unit&&e.isNumeric(a.month)&&e.isNumeric(a.monthDay)?n.setRecurrenceFn(n.recur(function(e,t){var n=e[l](a.number*t);return new Date(n.getFullYear(),a.month,a.monthDay)})):i&&a.unit&&null===a.ordinal&&null===a.weekday?n.setRecurrenceFn(n.recur(function(e,t){return e[l](a.number*t)})):(n.rangeDiv.el.empty(),n.setRecurrenceFn(),n.field.val().length>0&&n.rangeDiv.el.html(n.sarcasmArray[t.randNum(0,n.sarcasmArray.length-1)]),n.helpBtn.place())}},getVal:function(){var e=this,n=e.value,a="",r=t.Datetime.prototype.validDate;return a+=(r(n.startDate)?n.startDate.toString(e.dtFormat):"")+"|",a+=(r(n.endDate)?n.endDate.toString(e.dtFormat):"")+"|",a+=(n.unit||"")+"|",a+=(n.number||"")+"|",a+=(n.weekday||"")+"|",a+=(n.month||"")+"|",a+=(n.ordinal||"")+"|",a+=(n.monthDay||"")+"|",a+=n.occurrences||""},init:function(){var n=this,a=n.name+t.id();n.helpBtnName="help-"+t.id(),e(document).on("wuibtnclick click",'[name="'+n.helpBtnName+'"]',n.showHelp),n.items=[n.dates=new t.DateRange({required:!0}),n.rangeDiv=new t.O({name:a,el:e("<div>").addClass("recur-feedback").attr({tabindex:-1}),items:[n.helpBtn=new t.Button({text:"Help",name:n.helpBtnName})]})],t.Text.prototype.init.call(n),(n.elAlias||n.el).addClass("wui-recurrence"),n.dates.startDate.val("today"),e.extend(n.dates.endDate,{translateDate:function(e){var n=this;return e.toLowerCase().replace(/([\d]+)(?:x|\stimes)+/,function(t,a){return n.value=parseInt(a),e="",""}),e.length?t.Datetime.prototype.translateDate.call(n,e):n.value},processDate:function(n){var a=this,r=n||a.field.val();return r.length>0?(a.value=a.translateDate(r),a.validDate(a.value)?a.displayDate():a.displayDate(e.isNumeric(a.value)?"Ends after "+a.value+" occurrences.":a.sarcasmArray[t.randNum(0,a.sarcasmArray.length-1)]),a.value):(a.value=null,void a.displayDate(""))}}),e(document).on("calupdate."+n.dates.name,function(a,r,i,l){if(n.value){var u=0,o=n.value,d=t.Datetime.prototype.validDate,s=new Date(l.getTime()).addDays(l.getDaysInMonth()),c=o&&d(o.startDate)?o.startDate:new Date,m=new Date(c.getTime());if(s=d(o.endDate)&&o.endDate<s?o.endDate:s,i.find(".cal-recurrence").removeClass("cal-recurrence"),n.valIsOK)for(;s>m&&u>-1;)m=new Date(c.getTime()),m=n.recurrenceFn(m,u),m.getMonth()==l.getMonth()&&m.getFullYear()==l.getFullYear()&&i.find("a:contains("+m.getDate()+"):first").addClass("cal-recurrence"),u++,e.isNumeric(o.occurrences)&&u>=o.occurrences&&(u=-1)}})},interpret:function(){this.clearValue();var n=this,a=n.value,r=t.Datetime.prototype,i=e.extend(!0,[],r.days),l=e.extend(!0,[],r.months),u=n.dates.startDate.val(),o=n.dates.endDate.val(),d=n.field.val();i.push.apply(i,r.shortDays),l.push.apply(l,r.shortMonths);var s=new RegExp("("+i.join("\\b|")+")"),c=new RegExp("("+l.join("\\b|")+")"),m=new RegExp("("+l.join("\\b|")+") ([\\d]+)"),y=new RegExp("(one|two|three|four\\b|five|six|seven|eight|nine|ten|eleven|twelve|twenty|thirty|forty|fifty|sixty|sevety|eighty|ninety|hundred|thousand|million|billion|trillion|and|\\s|\\d|-)+","g");r.validDate(u)&&(a.startDate=u),r.validDate(o)?a.endDate=o:e.isNumeric(o)&&(a.occurrences=o),d=d.toLowerCase().replace(/(once|one time|single)/,function(){return a.occurrences=1,null!==o&&n.dates.endDate.val(a.endDate=null),d="",""}).replace(y,function(e){return e.length>1?" "+r.num2Dec(e)+" ":" "}).replace(/(first|second|third|fourth|last)/,function(e){return a.ordinal=n.ordTranslate(e),e}).replace(/^day ([\d]+)|the ([\d]+)(?:th|st|nd|rd)/,function(e,t){return a.monthDay=parseInt(t)," "}).replace(m,function(t,n,r){a.monthDay=r;var i=e.inArray(n,l);return a.month=i>l.length/2?i-l.length/2:i,n}).replace(c,function(t,n){var r=e.inArray(n,l);return a.month=r>l.length/2?r-l.length/2:r,n}).replace(/(\bday|daily|week|month|year)/,function(t){return e.isNumeric(a.number)||(a.number=1),t="daily"==t?"day":t,a.unit=t}).replace(s,function(t,n){var r=e.inArray(n,i);return a.weekday=r>i.length/2?r-i.length/2:r,e.isNumeric(a.weekday)&&null===a.unit&&e.extend(a,{unit:"week",number:1}),t}).replace(/[\d]+/,function(e){return a.number=parseInt(e),e})},makeString:function(){var n=this,a=n.value,r=t.Datetime.prototype.validDate(a.startDate);return 1==a.occurrences&&r?"Once":"week"==a.unit&&e.isNumeric(a.weekday)?"Every "+a.number+" weeks on "+Date.CultureInfo.dayNames[a.weekday]:"month"==a.unit&&e.isNumeric(a.monthDay)?"Day "+a.monthDay+" of every "+a.number+" months.":("month"==a.unit||"year"==a.unit)&&e.isNumeric(a.ordinal)&&e.isNumeric(a.weekday)?"Every "+a.number+" "+a.unit+"(s) on the "+n.ordTranslate(a.ordinal)+" "+Date.CultureInfo.dayNames[a.weekday]+("year"==a.unit?" in "+Date.CultureInfo.monthNames[a.month]:""):"year"==a.unit&&e.isNumeric(a.month)&&e.isNumeric(a.monthDay)?"Every "+a.number+" years on "+Date.CultureInfo.monthNames[a.month]+" "+a.monthDay:r&&a.unit&&null===a.ordinal&&null===a.weekday?"Every "+a.number+" "+a.unit+"(s)":""},ordTranslate:function(t){var n=["first","second","third","fourth","last"],a={first:1,second:2,third:3,fourth:4,last:5};return e.isNumeric(t)?n[t-1]:a[t]},recur:function(n){var a=this,r=a.value,i=t.Datetime.prototype;if(r&&i.validDate(r.startDate)){var l=0,u=a.maxPreviews,o=a.rangeDiv,d=e.isNumeric(r.occurrences)?r.occurrences:a.maxPreviews,s=i.validDate(r.startDate),c=i.validDate(r.endDate);for(o.el.empty(),1===d&&s?a.rangeDiv.append(e("<div>").text("One time on:")):r.after_last&&(u--,o.append(e("<div>").text("After last occurrence:")));d>l&&u>l;)try{var m=new Date(r.startDate.getTime());if(m=n(m,l),c&&m>r.endDate)l=a.maxPreviews;else{var y=m.getTime()>r.startDate.getTime()?m:r.startDate;o.append(e("<div>").text(y.toString(a.dispFormat))),l++}}catch(h){l=u}c?l>=u&&o.append(e("<div>").text("until "+r.endDate.toString(a.dispFormat))):e.isNumeric(r.occurrences)?r.occurrences>1&&d>u&&o.append(e("<div>").text("...and "+(r.occurrences-u)+" more times")):o.append(e("<div>").text("continues indefinitely"))}return n},sarcasmArray:["Not quite.","Huh?","Nope","Arg..","Sorry","What?","Bleck.","Nuh-uh.","Keep Trying.","No Entiendo."],setListeners:function(e){function t(t){e.interpret(),e.feedback(),t.stopPropagation()}return e.dates.startDate.el.on("input valchange",t),e.dates.endDate.el.on("input valchange",t),e.field.on("keyup",t)},setRecurrenceFn:function(e){return this.valIsOK="function"==typeof e,this.recurrenceFn=this.valIsOK?e:function(){}},setVal:function(t){if(t=t||"08-04-2014||0|year|10|2|10|2||","string"==typeof t){var n=this,a=t.split("|"),r=a[9];n.dates.startDate.val(a[0]),e.isNumeric(r)&&r>1?(n.dates.endDate.field.val(r+"x"),n.dates.endDate.processDate()):n.dates.endDate.val(a[1]),e.extend(n.value,{unit:a[2].length?a[2]:null,number:a[3].length?parseInt(a[3]):null,weekday:a[4].length?parseInt(a[4]):null,month:a[5].length?parseInt(a[5]):null,ordinal:a[6].length?parseInt(a[6]):null,monthDay:a[7].length?parseInt(a[7]):null,occurrences:a[8].length?parseInt(a[8]):null}),n.field.val(n.makeString()),n.feedback()}},showHelp:function(){new t.Window({title:"Recurrence Help",isModal:!1,width:400,items:[new t.O({el:e("<p>Possible values to enter into the recurrence field are:</p>").addClass("wui-msg")}),new t.O({el:'<ul class="recurrence_v"><li>Once</li><li>Every [number] of [(day|week|month|year)](s)</li><li>Every [number] of weeks on [weekday]</li><li>Every [number] of months on [ordinal] [weekday]</li><li>Day [month_day] of every [number] months</li><li>Every [number] of years on [month] [month_day]</li><li>Every [number] of years on [ordinal] [weekday] of [month]</li></ul>'}),new t.O({el:e("<p>Possible end date options are a date, or a number of occurrences in the format '6x' or '20 times'.</p>").addClass("wui-msg")})]})},validTest:function(){return this.valIsOK||!1}})}(jQuery,window[_wuiVar]);